{% extends "base.html" %}

{% block title %}Sensors - WNCC Aquaponics{% endblock %}

{% block content %}
<div class="container">
    <h1>🪲 Pods In Space Sensor Data Dashboard</h1>
    <p class="lead">Real-time monitoring of the WNCC NASA Pods In Space System</p>

    <!-- Ambient Conditions Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">🌿 Closed System Ambient Environmental Conditions</h3>
        </div>
        <div class="card-body">
            <div class="row" id="sensor-widgets">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Soil Moisture</h6>
                            <h2 class="display-4 text-dark" id="field4">--</h2>
                            <p class="text-muted small">%</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Temperature</h6>
                            <h2 class="display-4 text-dark" id="field1">--</h2>
                            <p class="text-muted small">°F</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Humidity</h6>
                            <h2 class="display-4 text-dark" id="field2">--</h2>
                            <p class="text-muted small">%</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Barometric Pressure</h6>
                            <h2 class="display-4 text-dark" id="field3">--</h2>
                            <p class="text-muted small">inHg</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
            // Fetch latest sensor data from Thingspeak API
            async function updateSensorData() {
                try {
                    const response = await fetch('https://api.thingspeak.com/channels/3128979/feeds/last.json');
                    const data = await response.json();
                    
                    if (data) {
                        document.getElementById('field1').textContent = data.field1 ? parseFloat(data.field1).toFixed(1) : '--';
                        document.getElementById('field2').textContent = data.field2 ? parseFloat(data.field2).toFixed(1) : '--';
                        document.getElementById('field3').textContent = data.field3 ? parseFloat(data.field3).toFixed(2) : '--';
                        document.getElementById('field4').textContent = data.field4 ? parseFloat(data.field4).toFixed(1) : '--';
                    }
                } catch (error) {
                    console.error('Error fetching sensor data:', error);
                }
            }
            
            // Update on page load and every 30 seconds
            updateSensorData();
            setInterval(updateSensorData, 30000);
            </script>
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <p class="text-muted">
                        <i class="bi bi-info-circle"></i> 
                        For detailed historical charts, visit 
                        <a href="https://thingspeak.com/channels/3128979" target="_blank" rel="noopener">
                            ThingSpeak Channel 3128979 <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center">
        <a href="{{ url_for('index') }}" class="btn btn-primary">View Live Stream</a>
    </div>

    {% endblock %}